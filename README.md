GetAwayFromMeeting
==================

It is packet converter from GoToMeeting  video files to other codec

Что такое Get Away From Meeting?
==================
Get Away From Meeting (Сбежать со встречи) - это скрипт для пакетного конвертирования видеофайлов с кодеком GoToMeeting в другой кодек.

Название программы происходит от противоположности к названию GoToMeeting.
g2m - это очень противный кодек, который разработали в Citrix. Практически все видео от ЦКО "Специалист" записаны в этом кодеке. Прикол в том, что с ним возникают проблемы даже в этом их родном Windows. Поэтому, чтобы посмотреть курс, нужно переконвертировать видеофайлы.

Какой версии используется кодек?
==================
Чуть ли не единственным способом конвертации из этого формата (если не считать захват экрана и подобные перекодировки) является использование g2mtranscoder.exe, который вшит в установщик GoToMeeting кодека. Однако, в последней сборке (на момент 13 декабря 2014 это сборка 2031) появилась визуализация видеокадров при конвертации и интерфейс выбора файла(ов) стал графическим. Так вот, он не работает. Напомню, что в прошлых версиях для конвертирования нужно было указать source=файл без кавычек, сейчас этот параметр игнорируется.

Если когда-то починят новую сборку, то можно будет использовать её в скрипте. В скрипт можно будет включить код автоматического скачивания и установки кодека. В данный момент прямая ссылка на файл следующая: https://www3.gotomeeting.com/downloads/200000000356035114/73F3D070F7ABF8B/null/manualFull/InstallCodec/g2m_codec.exe
Её можно узнать из тега form action в 217 строке исходного кода страницы скачивания:
https://www3.gotomeeting.com/codec?Portal=www.gotomeeting.com

Каким-то чудом я нашёл на своём компьютере сборку 1468, в которой всё (почти - попадаются проблемные файлы) работало. Так что скрипт будет работать с приложенными файлами этой сборки. Похоже, 1468 сборка поддерживает g2m4 (хотя это нужно уточнить).

Как пользоваться программой?
==================
Откройте в текстовом редакторе файл скрипта bat и пропишите пути для вашего случая:
G2MTRANSCODER_DIR: путь, где находятся файлы G2M.dll (кодек), g2mtranscoder.exe (перекодировщик), G2MResource_en.dll (прогресс-бар). 
 На Windows8 у меня путь такой: C:\Users\John\AppData\Local\Citrix\GoToMeeting\1468
 Также на Windows8 у меня такой: C:\Program files (x86)\Citrix\GoToMeeting\2031
 На Windows XP у меня путь такой C:\Program Files\Citrix\GoToMeeting\%номер версии%\
Как описано выше, новая сборка не работает, поэтому пропишите путь до файлов версии 1468. 

VIDEO_DIR: пропишите путь, где лежат несконвертированные видеофайлы. Они будут перезаписаны сконвертированными. Желательно, чтобы русских букв по пути не было, потому что в "консоли" Windows и в файловой системе Windows используется разные кодировки. Причём обе неправильные... Ну, это же мелко софт, сами понимаете...

Теперь вам нужно запустить файл скрипта. Процесс конвертирования будет отображаться в новом окошке, которое всплывёт автоматически. Имейте в виду, что за процессом всё же придётся периодически посматривать, потому что если попадётся проблемный файл, в окошке с прогресс-баром появится ошибка, но скрипт не будет выполняться дальше, пока вы не нажмёте кнопку ОК. Также имейте в виду, что процесс конвертации может просто вылететь, а скрипт будет считать, что файл сконвертировался успешно и приступит к следующему файлу.
Чтобы убедиться, что файл сконвертировался, можете сравнить его размер до конвертации и после, либо же проверить хеш сумму файла до конвертации и после. Для остановки скрипта можно попробовать нажать Ctrl + D, затем ввести yes.
Имейте в виду, что даже сконвертированные файлы могут содержать в себе "унаследованные" проблемы от исходных. Например, рассинхрон видео и аудио дорожек (на что не все плееры адекватно реагируют), перепутанные ключевые кадры (в результате чего картинка может не обновляться, перемотка работать неправильно), слишком тихий звук или характерные для курсов специалиста "пиканья" во время записи. Поэтому, я рекомендую после транскодировки данным скриптом ещё раз переконвертировать файл уже в другой формат. Возможно, есть какие-то конвертеры, которые смогут сразу перекодировать в нужный формат.

Объяснение кода скрипта
==================
Отключаем вывод названий выполняемых команд

Снимаем атрибуты "только чтение", "архивный", "системный", "скрытый" для всех wmv файлов и папок в папке с видео (включая вложенные папки и файлы wmv). Для справки выполните команду "attrib /?" без кавычек.

Для каждого wmv файла в папке с видео (и всех подпапках) делаем слудующее
Выводим сообщение о начеле конвертирования названия файла, вызываем собственно сам перекодировщик с указанием очередного файла в качестве источника (*1), выводим сообщение о конце перекодирования файла и так пока не пройдут все wmv файлы.

----
(*1)
Изначально планировалось наблюдать, не закончился ли процесс перекодировки файла.
Когда процесс завершится, цикл вызовет перекодировщик с указанинием следующего файла.
Однако, вызов конвертера не отдаёт управление, поэтому вызов донной процедуры бессмысленен (так как он будет вызван уже после конвертации, когда уже не надо).
Кроме того, содержимое наблюдателя за процессом приходилось выносить в отдельный bat файл, так как помещение его кода непосредственно в нужном месте ломало логику for цикла. Тем не менее, если как-то удастся запустить транскодер и сразу вернуть управление не дожидаясь его завершения, то можно будет использовать примерно такой код:
 
goto  check_if_process_g2mtranscoder_exists

:: Проверка на существование процесса перекодировки видео файла
:check_if_process_g2mtranscoder_exists
tasklist | findstr g2mtranscoder
:: В tasklist можно применить фильтр  /fi "imagename eq g2mtranscoder.exe" для поиска процесса, но tasklist всегда завершается успешно (всегда возвращает 0). Поэтому придётся вызвать  findstr, который уже может возвращать разные значения. Если процесс ещё выполняется, то подстрока g2mtranscoder будет найдена и в переменной errorlevel окажется значение  0. Если же не найдена, значит процесс завершён, и в переменной errorlevel будет значение 1.
		
:: Эт-символ  подавляет вывод названия команды. Выводим состояние errorlevel
@echo %errorlevel%
if %errorlevel% == 1 ( goto end ) ELSE (  
time -t >> log.txt
@ping -n 60 -w 1000 127.0.0.1
:: Если процесс ещё идёт, то ждём минуту (60 раз через каждую секунду посылаем пинг) и возвращаемся снова к проверке существования процесса
:: К сожалению, timeout, sleep, wait присутствуют не во всех версиях Windows, поэтому пользуемся командой ping. Зато она занимает меньше процессорного времени.
goto check_if_process_g2mtranscoder_exists ) 
:end
:: Если процесс завершился, выводим на экран строку
echo Процесс для данного файла завершён
:: После того, как цикл пройдет по всем файлам, он завершается.
)

:: Останавливаем скрипт до нажатия любой кнопки
Echo Все файлы прошли конвертацию. Нажмите что-нибудь для выхода.
pause > nul

Что можно улучшить?
==================
Пока я не нашёл способа записи времени операции и файла на одной строке в лог файл
Можно сделать возможность в интерактивном режиме выбирать необходимые файлы
Получение процентажа конвертации и времени файла ВО ВРЕМЯ конвертации и запись в лог
Конвертировать сразу в свободный формат, минуя конвертацию в wmv9.
Можно выводить в лог размер файла до конвертации и после
Если у кого-то остались другие версии кодека, предоставьте их для тестов.
